name: "Build dev-sbs Image"
on:
  workflow_dispatch:

jobs:
  build-image:
    name: "Build dev-sbs Image"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    env:
      NEXT_PUBLIC_DIGISOS_ENV: dev-sbs
      DOCKER_IMAGE: ghcr.io/${{ github.repository }}/${{ github.event.repository.name }}
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
      WORKFLOW_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: 'Build npm project'
        uses: navikt/sosialhjelp-ci/actions/build-npm@main
        with:
          node-version: 20
          build-less: 'false'
          reader-token: ${{ secrets.READER_TOKEN }}
          run-test: 'false'
          run-orval: 'true'

      - name: 'Upload static files to cdn'
        id: upload
        uses: nais/deploy/actions/cdn-upload/v2@master
        with:
          team: teamdigisos
          source: ./build/static
          destination: "/sosialhjelp-soknad/_next"
          project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}

      - name: "Build Docker Image"
        uses: navikt/sosialhjelp-soknad/.github/actions/build-image@master
        with:
          prefix: ${{ env.NEXT_PUBLIC_DIGISOS_ENV }}
